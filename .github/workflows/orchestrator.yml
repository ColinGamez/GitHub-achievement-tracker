# ================================================================
# GitHub Activity Orchestrator — Scheduled Workflow
# ================================================================
#
# This workflow runs the orchestrator on a cron schedule and
# supports manual dispatch for ad-hoc runs.
#
# It uses the repository's GITHUB_TOKEN (automatically provided)
# so no additional secrets are required for basic operation.
#
# Cron schedule: weekdays at 10:00 and 15:00 UTC.
# This mirrors a realistic developer cadence and avoids running
# on weekends.
# ================================================================

name: Orchestrator

on:
  # Scheduled runs — twice per weekday.
  schedule:
    # 10:00 UTC, Monday–Friday
    - cron: "0 10 * * 1-5"
    # 15:00 UTC, Monday–Friday
    - cron: "0 15 * * 1-5"

  # Manual trigger via GitHub UI or API.
  workflow_dispatch:
    inputs:
      max_issues:
        description: "Number of issues to create this run"
        required: false
        default: "1"
      max_prs:
        description: "Number of PRs to open this run"
        required: false
        default: "1"
      yolo_mode:
        description: "Merge PRs without review (YOLO achievement)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  orchestrate:
    name: Run Orchestrator
    runs-on: ubuntu-latest
    # Prevent overlapping runs — only one orchestrator at a time.
    concurrency:
      group: orchestrator
      cancel-in-progress: false

    steps:
      # ---- Checkout ----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---- Node.js setup ----------------------------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # ---- Install dependencies ----------------------------------------------
      - name: Install dependencies
        run: npm ci

      # ---- Build TypeScript --------------------------------------------------
      - name: Build
        run: npm run build

      # ---- Run Orchestrator --------------------------------------------------
      - name: Run orchestrator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
          MAX_ISSUES_PER_RUN: ${{ github.event.inputs.max_issues || '1' }}
          MAX_PRS_PER_RUN: ${{ github.event.inputs.max_prs || '1' }}
          YOLO_MODE: ${{ github.event.inputs.yolo_mode || 'false' }}
          AUTO_MERGE: "true"
          LOG_LEVEL: "info"
          # Co-author can be set via repository secrets if desired.
          CO_AUTHOR_NAME: ${{ secrets.CO_AUTHOR_NAME || '' }}
          CO_AUTHOR_EMAIL: ${{ secrets.CO_AUTHOR_EMAIL || '' }}
        run: node dist/src/index.js

      # ---- Commit analytics --------------------------------------------------
      # Persist updated analytics back to the repo so they accumulate.
      - name: Commit analytics
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/ analytics.md || true
          git diff --cached --quiet || git commit -m "chore: update analytics [skip ci]"
          git push || echo "Nothing to push."
